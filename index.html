<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="./config.js"></script>
  <title>PrettyQuizzer – Login</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #f0f2f5;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    #login {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      text-align: center;
      width: 320px;
    }
    select, button {
      width: 100%;
      margin-top: 0.75rem;
      padding: 0.75rem;
      font-size: 1rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button {
      cursor: pointer;
      border: none;
      color: white;
    }
    #signinInstitution { background: #17a2b8; }
    #signinInstitution:hover { background: #117a8b; }
    #signinTeacher { background: #0069d9; }
    #signinTeacher:hover { background: #0053a6; }
    #signinStudent { background: #28a745; }
    #signinStudent:hover { background: #1e7e34; }
    .error { color: #d00; margin-top: 1rem; }
  </style>
</head>
<body>

  <div id="login" style="display:none;">
    <h2>Select Institution</h2>
    <select id="institutionSelect">
      <option>Loading institutions…</option>
    </select>

    <h2>Who are you?</h2>
    <button id="signinInstitution">Institution Admin</button>
    <button id="signinTeacher">I’m a Teacher</button>
    <button id="signinStudent">I’m a Student</button>

    <div id="error" class="error"></div>
  </div>

  <!-- oidc-client to handle PKCE + OAuth code flow -->
  <script src="https://unpkg.com/oidc-client/dist/oidc-client.min.js"></script>
  <script>
  (async function(){
    const {
      AUTHORITY,
      CLIENT_ID,
      REDIRECT_URI,
      POST_LOGOUT_URI,
      SCOPE
    } = window.APP_CONFIG;

    const mgr = new Oidc.UserManager({
      authority:                AUTHORITY,
      client_id:                CLIENT_ID,
      redirect_uri:             REDIRECT_URI,
      post_logout_redirect_uri: POST_LOGOUT_URI,
      response_type:            'code',
      scope:                    SCOPE,
    });

    async function loadInstitutions() {
      const res = await fetch('https://yawptms26h.execute-api.us-east-2.amazonaws.com/prod/institutions');
      if (!res.ok) throw new Error('Could not load institutions');
      return res.json();
    }

    let insts;
    try {
      insts = await loadInstitutions();
    } catch (e) {
      document.getElementById('error').textContent = e.message;
      return;
    }
    const sel = document.getElementById('institutionSelect');
    sel.innerHTML = '<option value="">-- choose an institution --</option>';
    insts.forEach(i => {
      const o = document.createElement('option');
      o.value = i.id;
      o.textContent = i.name;
      sel.appendChild(o);
    });

    // OAuth callback & existing user logic unchanged...
    if (window.location.search.includes('code=')) {
      try {
        const user = await mgr.signinRedirectCallback();
        sessionStorage.setItem('id_token',      user.id_token);
        sessionStorage.setItem('access_token',  user.access_token);
        sessionStorage.setItem('refresh_token', user.refresh_token);
        sessionStorage.setItem('institutionId', user.state.institutionId);
        sessionStorage.setItem('role',          user.state.role);
        if (user.state.role === 'teacher') {
          window.location = 'Admin/dashboard.html';
        } else if (user.state.role === 'student') {
          window.location = 'Client/dashboard.html';
        } else {
          window.location = 'Institution/dashboard.html';
        }
        return;
      } catch (err) {
        document.getElementById('error').textContent = err.message || err;
        return;
      }
    }

    const existingUser = await mgr.getUser();
    if (existingUser) {
      const role = existingUser.state?.role || sessionStorage.getItem('role');
      if (role === 'teacher') {
        window.location = 'Admin/dashboard.html';
      } else if (role === 'student') {
        window.location = 'Client/dashboard.html';
      } else {
        window.location = 'Institution/dashboard.html';
      }
      return;
    }

    document.getElementById('login').style.display = 'block';
    document.getElementById('signinInstitution').onclick = () => {
      const inst = sel.value;
      if (!inst) { alert('Please pick an institution first'); return; }
      window.location = 'institution/login.html?inst=' + encodeURIComponent(inst);
    };
    document.getElementById('signinTeacher').onclick = () => {
      const inst = sel.value;
      if (!inst) { alert('Please pick an institution first'); return; }
      sessionStorage.setItem('institutionId', inst);
      mgr.signinRedirect({ state: { institutionId: inst, role: 'teacher' } });
    };
    document.getElementById('signinStudent').onclick = () => {
      const inst = sel.value;
      if (!inst) { alert('Please pick an institution first'); return; }
      sessionStorage.setItem('institutionId', inst);
      mgr.signinRedirect({ state: { institutionId: inst, role: 'student' } });
    };

  })();
  </script>
</body>
</html>
