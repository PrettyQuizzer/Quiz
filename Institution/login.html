<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PrettyQuizzer – Institution Login</title>
  <style>
    body { margin:0; font-family:sans-serif; background:#f0f2f5;
           height:100vh; display:flex; align-items:center; justify-content:center; }
    .card { background:#fff; width:360px; padding:2rem; border-radius:10px;
            box-shadow:0 2px 10px rgba(0,0,0,.08); text-align:center; }
    button { width:100%; padding:.8rem; margin-top:1rem; border:none; color:#fff;
             background:#17a2b8; border-radius:6px; font-size:1rem; cursor:pointer; }
    button[disabled]{opacity:.6; cursor:not-allowed;}
    button:hover { background:#117a8b; }
    .err { color:#c00; margin-top:1rem; word-break:break-word; }
    .muted { color:#666; font-size:.9rem; }
    code { background:#f3f3f3; padding:.1rem .3rem; border-radius:4px; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Institution Admin Login</h2>
    <p class="muted" id="instLabel">Preparing…</p>
    <button id="go" disabled>Sign in with Cognito</button>
    <div id="err" class="err"></div>
  </div>

  <script src="../config.js"></script>
  <script src="https://unpkg.com/oidc-client/dist/oidc-client.min.js"></script>
  <script>
    (async function () {
      const cfg = window.APP_CONFIG || {};
      const errEl = document.getElementById('err');
      const btn   = document.getElementById('go');
      const label = document.getElementById('instLabel');

      // 1) read ?inst=...
      const params = new URLSearchParams(location.search);
      const inst = params.get('inst');
      if (!inst) {
        label.textContent = 'No institution selected.';
        errEl.textContent = 'Go back and choose an institution first.';
        return;
      }
      label.textContent = `Institution ID: ${inst}`;

      // 2) choose authority strictly from AWS_DOMAIN (Hosted UI)
      const AUTHORITY = (cfg.AWS_DOMAIN || '').trim();

      // Safety checks to avoid the “pool id as domain” mistake
      const looksLikePoolId = /us-[a-z-]+\d+_[A-Za-z0-9]+/.test(AUTHORITY);
      const hasUnderscore   = AUTHORITY.includes('_');
      const isCognitoIdp    = /cognito-idp\./.test(AUTHORITY);
      const isHostedUiHost  = /\.auth\.[\w-]+\.amazoncognito\.com$/.test(AUTHORITY);

      if (!AUTHORITY) {
        errEl.textContent = 'Missing AWS_DOMAIN in config.js (Hosted UI domain).';
        return;
      }
      if (!isHostedUiHost || isCognitoIdp || hasUnderscore || looksLikePoolId) {
        errEl.innerHTML =
          'AWS_DOMAIN is not a valid Hosted UI domain. Set it to something like ' +
          '<code>https://yourprefix.auth.us-east-2.amazoncognito.com</code> (from Cognito → App integration → Domain name).';
        return;
      }

      // 3) preflight fetch the OIDC metadata for a clearer error if domain is wrong
      try {
        const wellKnown = AUTHORITY.replace(/\/+$/,'') + '/.well-known/openid-configuration';
        const r = await fetch(wellKnown, { cache: 'no-store' });
        if (!r.ok) throw new Error('Hosted UI domain is not responding with OIDC metadata.');
      } catch (e) {
        errEl.textContent = e.message + ' Check your domain prefix and region.';
        return;
      }

      // 4) configure OIDC client
      const mgr = new Oidc.UserManager({
        authority:                AUTHORITY,                // Hosted UI domain
        client_id:                cfg.CLIENT_ID,
        redirect_uri:             cfg.REDIRECT_URI,
        post_logout_redirect_uri: cfg.POST_LOGOUT_URI,
        response_type:            'code',
        scope:                    cfg.SCOPE
      });

      // Optional: already signed-in? bounce back
      try {
        const existing = await mgr.getUser();
        if (existing && existing.id_token) {
          sessionStorage.setItem('institutionId', inst);
          window.location = '../index.html';
          return;
        }
      } catch {}

      // 5) start login on click, carrying state
      btn.disabled = false;
      btn.onclick = () => {
        mgr.signinRedirect({ state: { institutionId: inst, role: 'institution' } })
          .catch(e => errEl.textContent = e && e.message ? e.message : String(e));
      };
    })();
  </script>
</body>
</html>
