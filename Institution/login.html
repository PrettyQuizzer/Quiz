<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PrettyQuizzer – Institution Login</title>
  <style>
    body { margin:0; font-family:sans-serif; background:#f0f2f5;
           height:100vh; display:flex; align-items:center; justify-content:center; }
    .card { background:#fff; width:340px; padding:2rem; border-radius:8px;
            box-shadow:0 2px 8px rgba(0,0,0,.08); text-align:center; }
    button { width:100%; padding:.75rem; margin-top:1rem; border:none; color:#fff;
             background:#17a2b8; border-radius:4px; font-size:1rem; cursor:pointer; }
    button:hover { background:#117a8b; }
    .error { color:#c00; margin-top:1rem; word-break:break-word; }
    .muted { color:#666; font-size:.9rem; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Institution Admin Login</h2>
    <p class="muted" id="instLabel">Preparing…</p>
    <button id="go">Sign in with Cognito</button>
    <div id="error" class="error"></div>
  </div>

  <script src="../config.js"></script>
  <script src="https://unpkg.com/oidc-client/dist/oidc-client.min.js"></script>
  <script>
    (async function () {
      const cfg = window.APP_CONFIG || {};
      // Prefer Hosted UI domain; fall back to AUTHORITY if needed
      const AUTHORITY = (cfg.AWS_DOMAIN && cfg.AWS_DOMAIN.startsWith('https://'))
        ? cfg.AWS_DOMAIN
        : cfg.AUTHORITY;

      const params = new URLSearchParams(location.search);
      const inst = params.get('inst');

      const label = document.getElementById('instLabel');
      const btn   = document.getElementById('go');
      const errEl = document.getElementById('error');

      if (!inst) {
        label.textContent = 'No institution selected.';
        btn.disabled = true;
        errEl.textContent = 'Go back and choose an institution first.';
        return;
      }

      label.textContent = `Institution ID: ${inst}`;

      const mgr = new Oidc.UserManager({
        authority:                AUTHORITY,                 // ← Hosted UI domain
        client_id:                cfg.CLIENT_ID,
        redirect_uri:             cfg.REDIRECT_URI,          // must be whitelisted in Cognito
        post_logout_redirect_uri: cfg.POST_LOGOUT_URI,
        response_type:            'code',
        scope:                    cfg.SCOPE
      });

      // If user already has a session, bounce back to your callback page
      try {
        const existing = await mgr.getUser();
        if (existing && existing.id_token) {
          sessionStorage.setItem('institutionId', inst);
          window.location = '../index.html';
          return;
        }
      } catch (_) {}

      btn.onclick = () => {
        // carry institution + role in state so your index callback can route properly
        mgr.signinRedirect({ state: { institutionId: inst, role: 'institution' } })
           .catch(e => errEl.textContent = e && e.message ? e.message : String(e));
      };

      // Optional: sanity check—warn if authority looks like the API endpoint (wrong)
      if (/cognito-idp\./.test(AUTHORITY)) {
        errEl.textContent =
          'Heads-up: AUTHORITY points to cognito-idp (API). Use your Hosted UI domain in AWS_DOMAIN.';
      }
    })();
  </script>
</body>
</html>
