<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PrettyQuizzer – Institution Login</title>
  <style>
    body{margin:0;font-family:sans-serif;background:#f0f2f5;height:100vh;display:flex;align-items:center;justify-content:center}
    .card{background:#fff;width:360px;padding:2rem;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.08);text-align:center}
    button{width:100%;padding:.8rem;margin-top:1rem;border:none;color:#fff;background:#17a2b8;border-radius:6px;font-size:1rem;cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    button:hover{background:#117a8b}
    .err{color:#c00;margin-top:1rem;word-break:break-word}
    .muted{color:#666;font-size:.9rem}
  </style>
</head>
<body>
  <div class="card">
    <h2>Institution Admin Login</h2>
    <p id="instLabel" class="muted">Preparing…</p>
    <button id="go" disabled>Sign in</button>
    <div id="err" class="err"></div>
  </div>

  <script src="../config.js"></script>
  <script src="https://unpkg.com/oidc-client/dist/oidc-client.min.js"></script>
  <script>
    (async function(){
      const cfg = window.APP_CONFIG || {};
      const params = new URLSearchParams(location.search);
      const inst  = params.get('inst');

      const errEl = document.getElementById('err');
      const btn   = document.getElementById('go');
      const label = document.getElementById('instLabel');

      if (!inst){
        label.textContent = 'No institution selected.';
        errEl.textContent = 'Go back and choose an institution first.';
        return;
      }
      label.textContent = `Institution ID: ${inst}`;

      // Use the SAME authority style as your working pages
      const oidcConfig = {
        authority:                cfg.AUTHORITY,         // e.g. https://cognito-idp.us-east-2.amazonaws.com/us-east-2_acveeSnQD
        client_id:                cfg.CLIENT_ID,
        redirect_uri:             cfg.REDIRECT_URI,      // https://prettyquizzer.github.io/Quiz/
        post_logout_redirect_uri: cfg.POST_LOGOUT_URI,
        response_type:            'code',
        scope:                    cfg.SCOPE,
        userStore:                new Oidc.WebStorageStateStore({ store: window.sessionStorage })
      };
      const mgr = new Oidc.UserManager(oidcConfig);

      // If already signed in in this tab, bounce to your SPA to finish callback/routing
      try {
        const existing = await mgr.getUser();
        if (existing && existing.id_token){
          sessionStorage.setItem('institutionId', inst);
          window.location = '../index.html';   // your SPA handles signinRedirectCallback()
          return;
        }
      } catch {}

      // Start the Hosted UI login via the discovery from AUTHORITY (your working pattern)
      btn.disabled = false;
      btn.onclick = () => {
        mgr.signinRedirect({ state: { institutionId: inst, role: 'institution' } })
           .catch(e => errEl.textContent = e?.message || String(e));
      };
    })();
  </script>
</body>
</html>
